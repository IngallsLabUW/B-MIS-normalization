---
title: "QE.XCMS.CyanoAq.TM2P.Diatoms.BMIS"
author: "Angie Boysen"
date: "Feb 9, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(ggplot2)
library(tidyr)
require(graphics); require(grDevices)
library(Hmisc)
library(gtools)
library(cowplot)
require(RColorBrewer)
# library(xlsx)
library(readr)
library(plotly)
library(stringr)
library(GGally)
library(dplyr)
```


#Setup Experiment
```{r Set experiment and fraction name,  results='hide', message=FALSE, warning=FALSE}

Location <- getwd()
Fraction <- "HILICPos"
FractionShort <- "HILIC" #HILIC or CyanoAq or CyanoDCM
ExpDIR <-Location

```



#Import data from xcms - set filename here
```{r}
filename <- "xset.filtered.csv"
xcms.dat <- read_csv(filename)
xcms.names <- names(xcms.dat)
```

##Read in Internal Standard data
```{r}
IS.dat <- read_csv("IS_Results.csv")
IS.dat <- IS.dat %>%
     select(`Replicate Name`, `Precursor Ion Name`, Area) %>%
     mutate(MassFeature = `Precursor Ion Name`) %>%
  select(-`Precursor Ion Name`)

#glimpse(IS.dat)
```

##add bioNorm data
```{r}
SampKey <- read_csv("sample.key.untargeted.csv") %>%
  filter(Fraction == FractionShort)%>%
    select(Sample.Name, Injec_vol) %>%
  filter(!is.na(Injec_vol)) %>%
  mutate(MassFeature = "Inj_vol") %>%
  rename(Area = Injec_vol,
         `Replicate Name` = Sample.Name)

IS.dat <- rbind(IS.dat, SampKey)
```


##look at extraction replication
if things don't look good with some IS make sure to fix them
or at least not include them as possibilities for normalization
```{r, echo=FALSE}
ggplot(IS.dat, aes(x=`Replicate Name`, y=Area)) + geom_bar(stat="identity") + facet_wrap( ~MassFeature, scales="free_y")+theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust = 0.5), legend.position = "top")  + ggtitle("IS Raw Areas")
```

##Edit IS data if necessary
```{r correctISErrors}
IS.dat <- IS.dat %>%
  filter (MassFeature != "Heavy Acetyl CoA") %>%
  filter (MassFeature != "Heavy Succinic Acid")
```


##Get untargeted data into long format
```{r}
IS.dat <- IS.dat %>% mutate(Replicate.Name = `Replicate Name` %>%
                                str_replace("-","."))  %>%
  select(Area, Replicate.Name, MassFeature)
replicates <- paste0("X",unique(IS.dat$Replicate.Name))

col.key <-  xcms.names %in% replicates
xcms.long <- cbind(xcms.dat[,col.key],MassFeature = xcms.dat$MassFeature) %>%
     gather(Replicate.Name, Area, -MassFeature)
```

##Rename Runs
Name structure must be:
Date_type_ID_replicate
```{r echo=FALSE}
xcms.long <- xcms.long %>%
  mutate(Replicate.Name = Replicate.Name %>%
            str_replace("_Blk_Blk_M","_Blk_M")%>%
            str_replace("ExtractsFull_","Extracts_Full")%>%
           str_replace("ExtractsHalf_","Extracts_Half"))

IS.dat <- IS.dat %>%
  mutate(Replicate.Name = Replicate.Name %>%
           str_replace("17","X17") %>%
            str_replace("_Blk_Blk_M","_Blk_M")%>%
           str_replace("ExtractsFull_","Extracts_Full")%>%
           str_replace("ExtractsHalf_","Extracts_Half"))
```

##Calculate mean values for each IS
```{r ISmeans}
IS.means <- IS.dat %>% filter(!grepl("Blk", Replicate.Name)) %>%
  mutate(MassFeature = as.factor(MassFeature))%>%
     group_by(MassFeature) %>%
     summarise(ave = mean(Area))
```

##Normalize to each internal Standard
Actually scaling/adjusting by dividing by IS peak area and multiplying by the average IS peak area.
Output is a dataframe 'area.norm' that has each peak adjusted
to each possible internal standards
```{r echo=FALSE}
binded <- rbind(IS.dat, xcms.long)
wArea<- binded %>% 
     select(Replicate.Name, MassFeature, Area) %>%
     spread(key=MassFeature, value=Area) %>%
     as.data.frame

IS.list <- unique(IS.dat$MassFeature)
this.IS <- IS.list[1]
area.norm <- wArea[,-1] %>% 
          sapply(FUN = function(x) x/wArea[,grep(this.IS,
                                                 names(wArea))]) %>%
          as_data_frame %>% mutate(Replicate.Name = wArea$Replicate.Name) %>%
          gather(MassFeature,Area_Norm, -Replicate.Name)
this.mean <- IS.means %>% filter(MassFeature==this.IS) %>% 
     select(ave) %>% as.numeric
area.norm <- area.norm %>% mutate(Area_Norm = Area_Norm*this.mean)
key <- ncol(area.norm)
count <- length(which(!is.na(area.norm$Area_Norm)))/
               length(unique(area.norm$Replicate.Name))
names(area.norm)[key] <- paste(this.IS,"Norm.Area",sep=".")
# print(paste(1, this.IS, count, sep="-"))

for (i in 2:length(IS.list)){
     this.IS <- IS.list[i]
     if(length(wArea[,grep(this.IS, names(wArea))])!=0){
          this.norm <- wArea[,-1] %>% 
               sapply(FUN = function(x) x/wArea[,grep(this.IS,
                                                      names(wArea))]) %>%
               as_data_frame %>% 
               mutate(Replicate.Name = wArea$Replicate.Name) %>%
               gather(MassFeature,Area_Norm, -Replicate.Name)
          this.mean <- IS.means %>% filter(MassFeature==this.IS) %>% 
               select(ave) %>% as.numeric
          this.norm <- this.norm %>% mutate(Area_Norm = Area_Norm*this.mean)
          key <- ncol(area.norm)
          area.norm[,key+1] <- this.norm$Area_Norm
          names(area.norm)[key+1] <- paste(this.IS,"Norm.Area",sep=".")
          count <- length(which(!is.na(this.norm$Area_Norm)))/
               length(unique(this.norm$Replicate.Name))
          # print(paste(i, this.IS, count, sep="-"))
     }
}
#glimpse(area.norm)
```


#Break Up the Names
Name structure must be:
Date_type_ID_replicate
```{r echo=FALSE}
mydata_new <- area.norm %>% separate(Replicate.Name, 
                                      c("runDate",
                                        "type","SampID","replicate"),"_") %>%
     mutate(Run.Cmpd = paste(area.norm$Replicate.Name,area.norm$MassFeature))
binded <- binded %>% mutate(Run.Cmpd = paste(Replicate.Name, MassFeature))

dat <- full_join(binded, mydata_new)
#glimpse(dat)
#write.csv(dat, "dat.temp.csv")
```

##Compare normalizations
get mean, sd, and rsd for each normalization of each compound for each sample type.
Output is a dataframe called 'rsd.stats'
```{r}
no.blank.dat <- dat %>% filter(type =="Smp" | type =="Poo") 

rsd.stats <- no.blank.dat %>% select(-Replicate.Name,  -Run.Cmpd,
                                     -runDate, -replicate) %>%
     gather(Normer, Value, -MassFeature, -type, - SampID) %>%
     group_by(MassFeature, type, SampID, Normer) %>%
     summarise(m = mean(Value, na.rm=T), 
                sd = sd(Value, na.rm=T), rsd = sd/m)
#glimpse(rsd.stats)
```

##Cleanup RSD data and add a minimizing column 
One based on the multiple injetions of the pooled sample "PooModel"
and one based on the injections of the biological replicates of samples "SmpModel"
```{r newModeMaker}
rsd.clean <- rsd.stats %>% filter(!is.na(m))  %>%
     filter(Normer!="Area")

SmpModel <- rsd.clean %>% filter(type=="Smp") %>%
     select(-m, -sd) %>%
     group_by(MassFeature, Normer) %>%
     summarise(Mean.rsd = mean(rsd, na.rm=T)) %>%
     summarise(SmpModelRSD = min(Mean.rsd),
               Smp.Picked.IS = unique(Normer)[which.min(Mean.rsd)])
PooModel <- rsd.clean %>% filter(type=="Poo") %>%
     select(-m, -sd) %>%
     group_by(MassFeature, Normer) %>%
     summarise(Mean.rsd = mean(rsd, na.rm=T)) %>%
     summarise(PooModelRSD = min(Mean.rsd),
               Poo.Picked.IS = unique(Normer)[which.min(Mean.rsd)][1])
Models <- full_join(PooModel, SmpModel)
#glimpse(Models)
```

##Merge Models and RSD data all together
```{r}
rsd.total <- full_join(rsd.stats, Models)
```

##Adjust the pooled model --> PooPlus model aka B-MIS model
Uses the PooModel for all compounds detected in the Pooled samples.
If a compound was detected in the sample but not the pooled then use the SmpModel.
Names this new complied model "PooPlus" (aka B-MIS)
Output of this section is 'rsd.total': A dataframe with mean, sd, and rsd for each compound, sample type, and normalization combination and a column indicating the poo, smp and pooPlus (B-MIS) internal standard selections 
```{r echo=FALSE}
rsd.total <- rsd.total %>%
     mutate(PooPlus.IS = Poo.Picked.IS) %>%
     mutate(PooPlusModelRSD = PooModelRSD)

no.poo.rows <-which(is.na(rsd.total$PooModelRSD))
rsd.total$PooPlus.IS[no.poo.rows] <- rsd.total$Smp.Picked.IS[no.poo.rows]
rsd.total$PooPlusModelRSD[no.poo.rows] <- rsd.total$SmpModelRSD[no.poo.rows]

rsd.total <- rsd.total %>% 
     select(-PooModelRSD,-PooPlusModelRSD,-SmpModelRSD)
#glimpse(rsd.total)
```

##Write out RSD data, if you want
```{r, eval=FALSE}
#write.csv(rsd.total, "All_normalization_rsd_dat.csv")
```


##Get Actual Normalized data not just the rsds
Only keep PooPlus (BMIS model)
```{r, echo=FALSE}
models <- rsd.total %>% ungroup %>%
     select(MassFeature, PooPlus.IS) %>%
     group_by(MassFeature) %>%
     summarise(PooPlusModel.IS = unique(PooPlus.IS))
dat <- dat %>% filter(!is.na(Replicate.Name))
dat.join <- as.data.frame(full_join(dat, models)) %>%
  mutate(PooPlusModel = NA)

split.on.IS <- as.factor(dat.join$PooPlusModel.IS)
split.dat.join <- split(dat.join, split.on.IS)
for (i in 1:length(split.dat.join)){
  col.key <-  which(names(split.dat.join[[i]])==names(split.dat.join)[i])
  split.dat.join[[i]]$PooPlusModel <- split.dat.join[[i]][,col.key]
}

unsplit.dat.join <- unsplit(split.dat.join, split.on.IS)

##write out that full normalized data
##The output of the B-MIS normalized data is in the column named PooPlusModel.
new.filename <- paste("BMISd",filename,sep="_")
# write.csv(unsplit.dat.join, paste(as.character(Dirs[Fraction, "ResultsDIR"]), "/", new.filename, sep = "", collapse = NULL))

```

